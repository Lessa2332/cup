<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>–ê–Ω—è - AR –ì—Ä–∞</title>
    
    <!-- Preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

    <!-- A-Frame and MindAR -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }

        html, body {
            height: 100%;
            overflow: hidden;
            background: transparent;
            font-family: 'Inter', sans-serif;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: #d4af37;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(212, 175, 55, 0.3);
            border-top: 4px solid #d4af37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* AR Scene */
        a-scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.5s ease;
            background: transparent;
        }

        a-scene.ready {
            opacity: 1;
        }

        /* Game Canvas */
        #gameCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 20;
            pointer-events: auto;
            touch-action: none;
        }

        /* HUD */
        .hud {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 30;
            text-align: center;
            color: white;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .hud.visible {
            opacity: 1;
        }

        .instructions {
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 8px;
            backdrop-filter: blur(10px);
        }

        .score {
            background: rgba(212, 175, 55, 0.9);
            color: #000;
            padding: 8px 20px;
            border-radius: 12px;
            font-weight: 800;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* Feedback Messages */
        .feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: 800;
            z-index: 40;
            opacity: 0;
            pointer-events: none;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.9);
            text-align: center;
            transition: opacity 0.3s ease;
            padding: 16px 24px;
            border-radius: 16px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            color: #d4af37;
        }

        .feedback.visible {
            opacity: 1;
        }

        /* Victory Screen */
        .victory {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            color: #d4af37;
            padding: 32px;
            border-radius: 24px;
            font-weight: 800;
            font-size: 28px;
            text-align: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
            backdrop-filter: blur(20px);
            border: 2px solid #d4af37;
            max-width: 90%;
            box-shadow: 0 8px 32px rgba(212, 175, 55, 0.3);
        }

        .victory.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .victory-message {
            margin-bottom: 20px;
        }

        .continue-btn {
            background: #d4af37;
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 16px;
        }

        .continue-btn:hover {
            background: #e6c550;
            transform: scale(1.05);
        }

        /* Marker Hint */
        #markerHint {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #d4af37;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            z-index: 30;
            opacity: 1;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(10px);
            max-width: 90%;
        }

        #markerHint.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Media Controls */
        .media-controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 35;
            display: flex;
            gap: 16px;
            pointer-events: auto;
            padding: 0 20px;
            width: 100%;
            max-width: 500px;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            flex-wrap: wrap;
        }

        .media-controls.visible {
            opacity: 1;
        }

        .media-btn {
            background: rgba(212, 175, 55, 0.95);
            color: #000;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .media-btn:hover {
            background: rgba(212, 175, 55, 1);
            transform: scale(1.05);
        }

        .media-btn:active {
            transform: scale(0.95);
        }

        .media-btn.active {
            background: rgba(255, 255, 255, 0.95);
            color: #000;
            border: 2px solid #d4af37;
        }

        .sound-btn {
            background: rgba(255, 255, 255, 0.9);
        }

        .sound-btn.on {
            background: rgba(212, 175, 55, 0.95);
        }

        /* Navigation Dots */
        .nav-dots {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 35;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .nav-dots.visible {
            opacity: 1;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dot.active {
            background: #d4af37;
            transform: scale(1.2);
        }

        /* Error Screen */
        .error-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            color: #fff;
            text-align: center;
            padding: 20px;
        }

        .error-screen.visible {
            display: flex;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .retry-btn {
            background: #d4af37;
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }

        @media (max-width: 480px) {
            .media-controls {
                gap: 10px;
                padding: 0 15px;
                bottom: 20px;
            }
            
            .media-btn {
                padding: 10px 16px;
                font-size: 14px;
                min-width: 110px;
            }
            
            .nav-dots {
                bottom: 85px;
            }
            
            .hud {
                bottom: 80px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è AR...</div>
    </div>

    <!-- Error Screen -->
    <div class="error-screen" id="errorScreen">
        <div class="error-icon">‚ö†Ô∏è</div>
        <div id="errorMessage">–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞</div>
        <button class="retry-btn" id="retryBtn">–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É</button>
    </div>

    <!-- AR Scene -->
    <a-scene
        mindar-image="imageTargetSrc: ./marker.mind; autoStart: true; uiLoading: no; uiError: no; maxTrack: 1;"
        embedded
        color-space="sRGB"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        id="arScene"
        style="background: transparent;">
        
        <a-assets>
            <!-- 2 –≤—ñ–¥–µ–æ -->
            <video id="video1" src="./video1.mp4" muted playsinline webkit-playsinline preload="auto"></video>
            <video id="video2" src="./video2.mp4" muted playsinline webkit-playsinline preload="auto"></video>
            
            <!-- 5 —Ñ–æ—Ç–æ -->
            <img id="photo1" src="./photo1.jpg" preload="auto">
            <img id="photo2" src="./photo2.jpg" preload="auto">
            <img id="photo3" src="./photo3.jpg" preload="auto">
            <img id="photo4" src="./photo4.jpg" preload="auto">
            <img id="photo5" src="./photo5.jpg" preload="auto">
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0">
            <!-- –í—Å—ñ –º–µ–¥—ñ–∞ –µ–ª–µ–º–µ–Ω—Ç–∏ (—Å–ø–æ—á–∞—Ç–∫—É –ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ) -->
            <!-- –í—ñ–¥–µ–æ -->
            <a-video
                src="#video1"
                width="1.7"
                height="3.0"
                position="0 0 0"
                visible="false"
                id="videoEntity1">
            </a-video>
            
            <a-video
                src="#video2"
                width="1.7"
                height="3.0"
                position="0 0 0"
                visible="false"
                id="videoEntity2">
            </a-video>
            
            <!-- –§–æ—Ç–æ -->
            <a-image
                src="#photo1"
                width="1.7"
                height="3.0"
                position="0 0 0"
                visible="false"
                id="photoEntity1">
            </a-image>
            
            <a-image
                src="#photo2"
                width="1.7"
                height="3.0"
                position="0 0 0"
                visible="false"
                id="photoEntity2">
            </a-image>
            
            <a-image
                src="#photo3"
                width="1.7"
                height="3.0"
                position="0 0 0"
                visible="false"
                id="photoEntity3">
            </a-image>
            
            <a-image
                src="#photo4"
                width="1.7"
                height="3.0"
                position="0 0 0"
                visible="false"
                id="photoEntity4">
            </a-image>
            
            <a-image
                src="#photo5"
                width="1.7"
                height="3.0"
                position="0 0 0"
                visible="false"
                id="photoEntity5">
            </a-image>
        </a-entity>
    </a-scene>

    <!-- Game Canvas -->
    <canvas id="gameCanvas"></canvas>

    <!-- HUD -->
    <div class="hud" id="hud">
        <div class="instructions">–õ–æ–≤–∏ —Ç—ñ–ª—å–∫–∏ –∫—Ä–∏–ª–∞ ü™Ω</div>
        <div class="score" id="score">–ö—Ä–∏–ª–∞: 0/10</div>
    </div>

    <!-- Feedback -->
    <div class="feedback" id="feedback"></div>

    <!-- Victory Screen -->
    <div class="victory" id="victory">
        <div class="victory-message">–ê–Ω—è –Ω–∞–¥–∞—î –∫—Ä–∏–ª–∞! üíã</div>
        <div>–¢–∏ –∑—ñ–±—Ä–∞–≤ —É—Å—ñ –∫—Ä–∏–ª–∞!</div>
        <button class="continue-btn" id="continueBtn">–ì—Ä–∞—Ç–∏ —â–µ —Ä–∞–∑</button>
    </div>

    <!-- Navigation Dots -->
    <div class="nav-dots" id="navDots">
        <!-- Dots will be generated dynamically -->
    </div>

    <!-- Media Controls -->
    <div class="media-controls" id="mediaControls">
        <button class="media-btn" id="prevBtn">‚óÄ –ü–æ–ø–µ—Ä–µ–¥–Ω—î</button>
        <button class="media-btn" id="playPauseBtn">‚ñ∂ –í—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏</button>
        <button class="media-btn" id="nextBtn">–ù–∞—Å—Ç—É–ø–Ω–µ ‚ñ∂</button>
        <button class="media-btn sound-btn" id="soundBtn">üîá –£–≤—ñ–º–∫. –∑–≤—É–∫</button>
        <button class="media-btn" id="saveBtn">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
        <button class="media-btn" id="shareBtn">üì§ –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—å</button>
    </div>

    <!-- Marker Hint -->
    <div id="markerHint">–ù–∞–ø—Ä–∞–≤—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —Ñ–æ—Ç–æ ü™Ω</div>

    <script>
        class ARGame {
            constructor() {
                // –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –º–µ–¥—ñ–∞
                this.MEDIA_CONFIG = {
                    videos: [
                        { id: 'video1', entityId: 'videoEntity1', type: 'video', name: '–í—ñ–¥–µ–æ 1' },
                        { id: 'video2', entityId: 'videoEntity2', type: 'video', name: '–í—ñ–¥–µ–æ 2' }
                    ],
                    photos: [
                        { id: 'photo1', entityId: 'photoEntity1', type: 'photo', name: '–§–æ—Ç–æ 1' },
                        { id: 'photo2', entityId: 'photoEntity2', type: 'photo', name: '–§–æ—Ç–æ 2' },
                        { id: 'photo3', entityId: 'photoEntity3', type: 'photo', name: '–§–æ—Ç–æ 3' },
                        { id: 'photo4', entityId: 'photoEntity4', type: 'photo', name: '–§–æ—Ç–æ 4' },
                        { id: 'photo5', entityId: 'photoEntity5', type: 'photo', name: '–§–æ—Ç–æ 5' }
                    ]
                };

                // –û–±'—î–¥–Ω—É—î–º–æ –≤—Å–µ –º–µ–¥—ñ–∞ –≤ –æ–¥–∏–Ω –º–∞—Å–∏–≤
                this.allMedia = [...this.MEDIA_CONFIG.videos, ...this.MEDIA_CONFIG.photos];
                this.currentMediaIndex = 0;
                this.currentMediaType = 'video'; // 'video' –∞–±–æ 'photo'
                
                this.initializeElements();
                this.setupGameState();
                this.bindEvents();
                this.adjustControlsForSafeArea();
                this.createNavigationDots();
            }

            initializeElements() {
                this.scene = document.getElementById('arScene');
                this.gameCanvas = document.getElementById('gameCanvas');
                this.ctx = this.gameCanvas.getContext('2d');
                
                this.loadingScreen = document.getElementById('loadingScreen');
                this.errorScreen = document.getElementById('errorScreen');
                this.errorMessage = document.getElementById('errorMessage');
                this.retryBtn = document.getElementById('retryBtn');
                this.hud = document.getElementById('hud');
                this.scoreEl = document.getElementById('score');
                this.feedbackEl = document.getElementById('feedback');
                this.victoryEl = document.getElementById('victory');
                this.continueBtn = document.getElementById('continueBtn');
                this.markerHint = document.getElementById('markerHint');
                this.mediaControls = document.getElementById('mediaControls');
                this.navDots = document.getElementById('navDots');
                
                // –ö–Ω–æ–ø–∫–∏ –∫–µ—Ä—É–≤–∞–Ω–Ω—è
                this.prevBtn = document.getElementById('prevBtn');
                this.nextBtn = document.getElementById('nextBtn');
                this.playPauseBtn = document.getElementById('playPauseBtn');
                this.soundBtn = document.getElementById('soundBtn');
                this.saveBtn = document.getElementById('saveBtn');
                this.shareBtn = document.getElementById('shareBtn');

                this.validateElements();
                this.resizeCanvas();
                
                // –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –≤—Å—ñ –≤—ñ–¥–µ–æ –µ–ª–µ–º–µ–Ω—Ç–∏
                this.videoElements = {
                    video1: document.getElementById('video1'),
                    video2: document.getElementById('video2')
                };
            }

            validateElements() {
                const required = [
                    this.scene, this.gameCanvas, this.ctx,
                    this.loadingScreen, this.hud, this.scoreEl, this.feedbackEl,
                    this.victoryEl, this.markerHint, this.mediaControls
                ];
                required.forEach(el => {
                    if (!el) throw new Error('DOM element missing');
                });
            }

            createNavigationDots() {
                this.navDots.innerHTML = '';
                this.allMedia.forEach((media, index) => {
                    const dot = document.createElement('div');
                    dot.className = 'dot';
                    dot.dataset.index = index;
                    dot.addEventListener('click', () => this.switchToMedia(index));
                    this.navDots.appendChild(dot);
                });
                this.updateNavigationDots();
            }

            updateNavigationDots() {
                const dots = this.navDots.querySelectorAll('.dot');
                dots.forEach((dot, index) => {
                    if (index === this.currentMediaIndex) {
                        dot.classList.add('active');
                    } else {
                        dot.classList.remove('active');
                    }
                });
            }

            setupGameState() {
                this.gameState = {
                    isMarkerFound: false,
                    score: 0,
                    TARGET_SCORE: 10,
                    fallingItems: [],
                    gameActive: false,
                    animationId: null,
                    soundEnabled: false,
                    lastSpawnTime: 0,
                    SPAWN_INTERVAL: 300,
                    WING_PROBABILITY: 0.6,
                    isPlaying: false
                };
            }

            bindEvents() {
                window.addEventListener('resize', () => this.throttledResize());
                window.addEventListener('error', (e) => this.handleGlobalError(e));

                if (window.visualViewport) {
                    window.visualViewport.addEventListener('resize', () => {
                        this.adjustControlsForSafeArea();
                    });
                }

                this.gameCanvas.addEventListener('pointerdown', (e) => this.handleTap(e));
                this.gameCanvas.addEventListener('touchstart', (e) => e.preventDefault(), { passive: false });

                // –ö–Ω–æ–ø–∫–∏ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –º–µ–¥—ñ–∞
                this.prevBtn.addEventListener('click', () => this.previousMedia());
                this.nextBtn.addEventListener('click', () => this.nextMedia());
                this.playPauseBtn.addEventListener('click', () => this.togglePlayPause());
                this.soundBtn.addEventListener('click', () => this.toggleSound());
                this.saveBtn.addEventListener('click', () => this.saveCurrentMedia());
                this.shareBtn.addEventListener('click', () => this.shareCurrentMedia());
                
                this.continueBtn.addEventListener('click', () => this.restartGame());
                this.retryBtn.addEventListener('click', () => this.retryAR());

                // –°–ª—É—Ö–∞—á—ñ –¥–ª—è –≤—Å—ñ—Ö –≤—ñ–¥–µ–æ
                Object.values(this.videoElements).forEach(video => {
                    video.addEventListener('loadeddata', () => console.log('Video loaded:', video.id));
                    video.addEventListener('error', (e) => this.handleVideoError(e));
                    video.addEventListener('ended', () => this.handleVideoEnd(video));
                });

                this.scene.addEventListener('renderstart', () => this.handleARLoad());
                this.scene.addEventListener('targetFound', () => this.handleTargetFound());
                this.scene.addEventListener('targetLost', () => this.handleTargetLost());
                this.scene.addEventListener('arError', (e) => this.handleARError(e));
            }

            adjustControlsForSafeArea() {
                if (window.visualViewport) {
                    const viewportHeight = window.visualViewport.height;
                    const layoutHeight = window.innerHeight;
                    const navBarHeight = Math.max(0, layoutHeight - viewportHeight);
                    
                    // –ö–æ—Ä–µ–∫—Ü—ñ—è –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤–Ω–∏–∑—É
                    this.mediaControls.style.bottom = `${30 + navBarHeight}px`;
                    this.navDots.style.bottom = `${100 + navBarHeight}px`;
                    this.hud.style.bottom = `${80 + navBarHeight}px`;
                }
            }

            resizeCanvas() {
                const dpr = window.devicePixelRatio || 1;
                this.gameCanvas.width = window.innerWidth * dpr;
                this.gameCanvas.height = window.innerHeight * dpr;
                this.gameCanvas.style.width = `${window.innerWidth}px`;
                this.gameCanvas.style.height = `${window.innerHeight}px`;
                this.ctx.scale(dpr, dpr);
            }

            throttledResize() {
                clearTimeout(this.resizeTimeout);
                this.resizeTimeout = setTimeout(() => this.resizeCanvas(), 100);
            }

            // –ü–æ–∫–∞–∑—É—î–º–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–µ –º–µ–¥—ñ–∞
            showMedia(index) {
                const media = this.allMedia[index];
                if (!media) return;
                
                // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –≤—Å—ñ –º–µ–¥—ñ–∞
                this.allMedia.forEach(m => {
                    const entity = document.getElementById(m.entityId);
                    if (entity) entity.setAttribute('visible', false);
                });
                
                // –ü–∞—É–∑–∏–º–æ –≤—Å—ñ –≤—ñ–¥–µ–æ
                Object.values(this.videoElements).forEach(video => {
                    if (!video.paused) video.pause();
                });
                
                // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ—Ç–æ—á–Ω–µ –º–µ–¥—ñ–∞
                const currentEntity = document.getElementById(media.entityId);
                if (currentEntity) {
                    currentEntity.setAttribute('visible', true);
                    
                    if (media.type === 'video') {
                        const videoEl = this.videoElements[media.id];
                        if (videoEl) {
                            this.currentMediaType = 'video';
                            this.gameState.isPlaying = true;
                            videoEl.play().catch(e => console.warn('Video play failed'));
                            this.playPauseBtn.innerHTML = '‚è∏ –ü–∞—É–∑–∞';
                        }
                    } else {
                        this.currentMediaType = 'photo';
                        this.gameState.isPlaying = false;
                        this.playPauseBtn.innerHTML = '‚ñ∂ –í—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏';
                    }
                }
                
                this.currentMediaIndex = index;
                this.updateNavigationDots();
                this.updateMediaControls();
            }

            getCurrentMedia() {
                return this.allMedia[this.currentMediaIndex];
            }

            updateMediaControls() {
                const media = this.getCurrentMedia();
                if (media.type === 'video') {
                    this.playPauseBtn.style.display = 'flex';
                    this.soundBtn.style.display = 'flex';
                } else {
                    this.playPauseBtn.style.display = 'none';
                    this.soundBtn.style.display = 'none';
                }
                
                // –û–Ω–æ–≤–ª—é—î–º–æ —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
                this.saveBtn.innerHTML = media.type === 'video' ? 'üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –≤—ñ–¥–µ–æ' : 'üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ —Ñ–æ—Ç–æ';
            }

            switchToMedia(index) {
                if (index < 0 || index >= this.allMedia.length) return;
                this.showMedia(index);
            }

            nextMedia() {
                let nextIndex = this.currentMediaIndex + 1;
                if (nextIndex >= this.allMedia.length) nextIndex = 0;
                this.showMedia(nextIndex);
                this.showFeedback('–ù–∞—Å—Ç—É–ø–Ω–µ ‚û°Ô∏è', true);
            }

            previousMedia() {
                let prevIndex = this.currentMediaIndex - 1;
                if (prevIndex < 0) prevIndex = this.allMedia.length - 1;
                this.showMedia(prevIndex);
                this.showFeedback('–ü–æ–ø–µ—Ä–µ–¥–Ω—î ‚¨ÖÔ∏è', true);
            }

            togglePlayPause() {
                const media = this.getCurrentMedia();
                if (media.type !== 'video') return;
                
                const videoEl = this.videoElements[media.id];
                if (!videoEl) return;
                
                if (this.gameState.isPlaying) {
                    videoEl.pause();
                    this.playPauseBtn.innerHTML = '‚ñ∂ –í—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏';
                    this.showFeedback('–ü–∞—É–∑–∞ ‚è∏', false);
                } else {
                    videoEl.play();
                    this.playPauseBtn.innerHTML = '‚è∏ –ü–∞—É–∑–∞';
                    this.showFeedback('–í—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è ‚ñ∂Ô∏è', true);
                }
                
                this.gameState.isPlaying = !this.gameState.isPlaying;
            }

            async toggleSound() {
                this.gameState.soundEnabled = !this.gameState.soundEnabled;
                
                // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–≤—É–∫ –¥–ª—è –≤—Å—ñ—Ö –≤—ñ–¥–µ–æ
                Object.values(this.videoElements).forEach(video => {
                    video.muted = !this.gameState.soundEnabled;
                });
                
                if (this.gameState.soundEnabled) {
                    this.soundBtn.innerHTML = 'üîä –í–∏–º–∫. –∑–≤—É–∫';
                    this.soundBtn.classList.add('on');
                    this.showFeedback('–ó–≤—É–∫ —É–≤—ñ–º–∫–Ω–µ–Ω–æ üîä', true);
                    
                    // –°–ø—Ä–æ–±—É—î–º–æ –≤—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ—Ç–æ—á–Ω–µ –≤—ñ–¥–µ–æ –∑—ñ –∑–≤—É–∫–æ–º
                    const media = this.getCurrentMedia();
                    if (media.type === 'video') {
                        const videoEl = this.videoElements[media.id];
                        if (videoEl) {
                            try { await videoEl.play(); } catch (e) { console.warn('Audio play failed'); }
                        }
                    }
                } else {
                    this.soundBtn.innerHTML = 'üîá –£–≤—ñ–º–∫. –∑–≤—É–∫';
                    this.soundBtn.classList.remove('on');
                    this.showFeedback('–ó–≤—É–∫ –≤–∏–º–∫–Ω–µ–Ω–æ üîá', false);
                }
            }

            spawnItem() {
                if (!this.gameState.gameActive) return;
                const now = performance.now();
                if (now - this.gameState.lastSpawnTime < this.gameState.SPAWN_INTERVAL) return;

                const isWing = Math.random() < this.gameState.WING_PROBABILITY;
                const emoji = isWing ? 'ü™Ω' : ['üéÇ', 'üç∑', 'üéÅ', 'üåπ', 'üòÇ'][Math.floor(Math.random() * 5)];

                this.gameState.fallingItems.push({
                    x: Math.random() * (window.innerWidth - 60) + 30,
                    y: -60,
                    size: 32 + Math.random() * 20,
                    speed: 2 + Math.random() * 3,
                    emoji,
                    isWing,
                    id: now + Math.random()
                });

                this.gameState.lastSpawnTime = now;
            }

            update() {
                if (!this.gameState.gameActive) return;

                this.ctx.clearRect(0, 0, this.gameCanvas.width, this.gameCanvas.height);
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';

                for (let i = this.gameState.fallingItems.length - 1; i >= 0; i--) {
                    const item = this.gameState.fallingItems[i];
                    item.y += item.speed;
                    this.ctx.font = `bold ${item.size}px sans-serif`;
                    this.ctx.fillText(item.emoji, item.x, item.y);

                    if (item.y > window.innerHeight + 100) {
                        this.gameState.fallingItems.splice(i, 1);
                    }
                }

                this.spawnItem();
                this.gameState.animationId = requestAnimationFrame(() => this.update());
            }

            handleTap(event) {
                if (!this.gameState.gameActive) return;
                const rect = this.gameCanvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;

                let hit = false;
                for (let i = this.gameState.fallingItems.length - 1; i >= 0; i--) {
                    const item = this.gameState.fallingItems[i];
                    const dx = x - item.x;
                    const dy = y - item.y;
                    const distance = Math.sqrt(dx*dx + dy*dy);
                    if (distance < item.size * 0.6) {
                        hit = true;
                        const isWing = item.isWing;
                        this.gameState.fallingItems.splice(i, 1);
                        if (isWing) {
                            this.gameState.score++;
                            this.updateScore();
                            this.showFeedback('+1 –∫—Ä–∏–ª–æ! ü™Ω', true);
                            if (this.gameState.score >= this.gameState.TARGET_SCORE) {
                                this.endGame(true);
                            }
                        } else {
                            this.showFeedback('–û–π, —â–µ –±–µ–∑ –∫—Ä–∏–ª üòÖ', false);
                        }
                        break;
                    }
                }
                if (!hit) this.showFeedback('–ú—ñ–º–æ! üëÜ', false);
            }

            startGame() {
                if (this.gameState.gameActive) return;
                this.gameState.gameActive = true;
                this.gameState.score = 0;
                this.gameState.fallingItems = [];
                this.updateScore();
                this.showHUD(true);
                this.showMediaControls(true);
                this.hideVictory();
                this.update();
            }

            endGame(isWin) {
                this.gameState.gameActive = false;
                if (this.gameState.animationId) {
                    cancelAnimationFrame(this.gameState.animationId);
                    this.gameState.animationId = null;
                }
                if (isWin) this.showVictory();
            }

            restartGame() {
                this.hideVictory();
                this.startGame();
            }

            updateScore() {
                this.scoreEl.textContent = `–ö—Ä–∏–ª–∞: ${this.gameState.score}/${this.gameState.TARGET_SCORE}`;
            }

            async saveCurrentMedia() {
                try {
                    const media = this.getCurrentMedia();
                    const fileName = media.type === 'video' ? 'anya-video.mp4' : 'anya-photo.jpg';
                    const fileUrl = media.type === 'video' ? './' + media.id + '.mp4' : './' + media.id + '.jpg';
                    
                    const link = document.createElement('a');
                    link.href = fileUrl;
                    link.download = fileName;
                    link.click();
                    
                    this.showFeedback(`${media.type === 'video' ? '–í—ñ–¥–µ–æ' : '–§–æ—Ç–æ'} –∑–±–µ—Ä–µ–∂–µ–Ω–æ! üíæ`, true);
                } catch (error) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è:', error);
                    this.showFeedback('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è üòî', false);
                }
            }

            async shareCurrentMedia() {
                try {
                    const media = this.getCurrentMedia();
                    
                    if (navigator.share) {
                        await navigator.share({
                            title: `${media.type === 'video' ? '–í—ñ–¥–µ–æ' : '–§–æ—Ç–æ'} –∑ –ê–Ω–µ—é`,
                            text: `–ü–æ–¥–∏–≤–∏—Å—å –Ω–∞ —Ü–µ ${media.type === 'video' ? '–≤—ñ–¥–µ–æ' : '—Ñ–æ—Ç–æ'}!`,
                            url: window.location.href,
                        });
                        this.showFeedback('–ü–æ–¥—ñ–ª–∏–ª–∏—Å—å —É—Å–ø—ñ—à–Ω–æ! üì§', true);
                    } else {
                        // Fallback –¥–ª—è –±—Ä–∞—É–∑–µ—Ä—ñ–≤ –±–µ–∑ Web Share API
                        navigator.clipboard.writeText(window.location.href);
                        this.showFeedback('–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ! üìã', true);
                    }
                } catch (error) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –ø–æ–¥—ñ–ª—É:', error);
                    this.showFeedback('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–æ–¥—ñ–ª–∏—Ç–∏—Å—å üòî', false);
                }
            }

            handleVideoEnd(video) {
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–º–∏–∫–∞—î–º–æ –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–µ –≤—ñ–¥–µ–æ
                if (this.getCurrentMedia().type === 'video') {
                    setTimeout(() => this.nextMedia(), 500);
                }
            }

            showFeedback(text, isGood = true) {
                this.feedbackEl.textContent = text;
                this.feedbackEl.style.color = isGood ? '#d4af37' : '#ff6b6b';
                this.feedbackEl.classList.add('visible');
                setTimeout(() => this.feedbackEl.classList.remove('visible'), 1500);
            }

            showHUD(show) { 
                show ? this.hud.classList.add('visible') : this.hud.classList.remove('visible'); 
            }
            
            showMediaControls(show) { 
                show ? this.mediaControls.classList.add('visible') : this.mediaControls.classList.remove('visible'); 
                show ? this.navDots.classList.add('visible') : this.navDots.classList.remove('visible'); 
            }
            
            hideMediaControls() { 
                this.mediaControls.classList.remove('visible'); 
                this.navDots.classList.remove('visible'); 
            }
            
            showVictory() { 
                this.victoryEl.classList.add('visible'); 
            }
            
            hideVictory() { 
                this.victoryEl.classList.remove('visible'); 
            }
            
            hideMarkerHint() { 
                this.markerHint.classList.add('hidden'); 
            }
            
            showMarkerHint() { 
                this.markerHint.classList.remove('hidden'); 
            }
            
            hideLoading() { 
                this.loadingScreen.style.display = 'none'; 
            }
            
            showError(msg) { 
                this.errorMessage.textContent = msg; 
                this.errorScreen.classList.add('visible'); 
                this.hideLoading(); 
            }
            
            hideError() { 
                this.errorScreen.classList.remove('visible'); 
            }

            handleARLoad() {
                this.hideLoading();
                this.scene.classList.add('ready');
            }

            handleTargetFound() {
                this.gameState.isMarkerFound = true;
                this.hideMarkerHint();
                
                // –ü–æ–∫–∞–∑—É—î–º–æ –ø–µ—Ä—à–µ –º–µ–¥—ñ–∞
                this.showMedia(0);
                this.startGame();
            }

            handleTargetLost() {
                this.gameState.isMarkerFound = false;
                
                // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –≤—Å—ñ –º–µ–¥—ñ–∞
                this.allMedia.forEach(m => {
                    const entity = document.getElementById(m.entityId);
                    if (entity) entity.setAttribute('visible', false);
                });
                
                // –ü–∞—É–∑–∏–º–æ –≤—Å—ñ –≤—ñ–¥–µ–æ
                Object.values(this.videoElements).forEach(video => {
                    if (!video.paused) video.pause();
                });
                
                this.gameState.gameActive = false;
                this.gameState.isPlaying = false;
                
                if (this.gameState.animationId) {
                    cancelAnimationFrame(this.gameState.animationId);
                    this.gameState.animationId = null;
                }
                
                this.showHUD(false);
                this.hideMediaControls();
                this.hideVictory();
                this.gameState.fallingItems = [];
                this.showMarkerHint();
            }

            handleGlobalError(e) { 
                this.showError('–ù–µ–æ—á—ñ–∫—É–≤–∞–Ω–∞ –ø–æ–º–∏–ª–∫–∞'); 
            }
            
            handleVideoError(e) { 
                console.error('Video error:', e);
                this.showFeedback('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–µ–æ', false); 
            }
            
            handleARError(e) { 
                this.showError('–ü–æ–º–∏–ª–∫–∞ AR: ' + (e.detail || '')); 
            }

            retryAR() {
                this.hideError();
                this.loadingScreen.style.display = 'flex';
                setTimeout(() => window.location.reload(), 500);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => new ARGame());
        } else {
            new ARGame();
        }
    </script>
</body>
</html>
