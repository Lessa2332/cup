<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>AR –ì–∞–ª–µ—Ä–µ—è</title>
    
    <!-- Preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

    <!-- A-Frame and MindAR -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }

        html, body {
            height: 100%;
            overflow: hidden;
            background: transparent;
            font-family: 'Inter', sans-serif;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: #d4af37;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(212, 175, 55, 0.3);
            border-top: 4px solid #d4af37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* AR Scene */
        a-scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.5s ease;
            background: transparent;
        }

        a-scene.ready {
            opacity: 1;
        }

        /* Feedback Messages */
        .feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: 800;
            z-index: 40;
            opacity: 0;
            pointer-events: none;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.9);
            text-align: center;
            transition: opacity 0.3s ease;
            padding: 16px 24px;
            border-radius: 16px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            color: #d4af37;
        }

        .feedback.visible {
            opacity: 1;
        }

        /* Marker Hint */
        #markerHint {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #d4af37;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            z-index: 30;
            opacity: 1;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(10px);
            max-width: 90%;
        }

        #markerHint.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Media Controls */
        .media-controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 35;
            display: flex;
            gap: 16px;
            pointer-events: auto;
            padding: 0 20px;
            width: 100%;
            max-width: 500px;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            flex-wrap: wrap;
        }

        .media-controls.visible {
            opacity: 1;
        }

        .media-btn {
            background: rgba(212, 175, 55, 0.95);
            color: #000;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            opacity: 1;
        }

        .media-btn:hover {
            background: rgba(212, 175, 55, 1);
            transform: scale(1.05);
        }

        .media-btn:active {
            transform: scale(0.95);
        }

        .media-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .sound-btn {
            background: rgba(255, 255, 255, 0.9);
        }

        .sound-btn.on {
            background: rgba(212, 175, 55, 0.95);
        }

        /* Navigation Dots */
        .nav-dots {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 35;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .nav-dots.visible {
            opacity: 1;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dot.active {
            background: #d4af37;
            transform: scale(1.2);
        }

        /* Error Screen */
        .error-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            color: #fff;
            text-align: center;
            padding: 20px;
        }

        .error-screen.visible {
            display: flex;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .retry-btn {
            background: #d4af37;
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }

        /* Media Info */
        .media-info {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: #d4af37;
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            z-index: 30;
            opacity: 0;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .media-info.visible {
            opacity: 1;
        }

        @media (max-width: 480px) {
            .media-controls {
                gap: 10px;
                padding: 0 15px;
                bottom: 20px;
            }
            
            .media-btn {
                padding: 10px 16px;
                font-size: 14px;
                min-width: 110px;
            }
            
            .nav-dots {
                bottom: 85px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è AR...</div>
    </div>

    <!-- Error Screen -->
    <div class="error-screen" id="errorScreen">
        <div class="error-icon">‚ö†Ô∏è</div>
        <div id="errorMessage">–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞</div>
        <button class="retry-btn" id="retryBtn">–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É</button>
    </div>

    <!-- AR Scene -->
    <a-scene
        mindar-image="imageTargetSrc: ./marker.mind; autoStart: true; uiLoading: no; uiError: no; maxTrack: 1;"
        embedded
        color-space="sRGB"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        id="arScene"
        style="background: transparent;">
        
        <a-assets>
            <!-- 2 –≤—ñ–¥–µ–æ -->
            <video id="video1" src="./videos/video1.mp4" muted playsinline webkit-playsinline preload="auto"></video>
            <video id="video2" src="./videos/video2.mp4" muted playsinline webkit-playsinline preload="auto"></video>
            
            <!-- 5 —Ñ–æ—Ç–æ -->
            <img id="photo1" src="./photos/photo1.jpg" crossorigin="anonymous">
            <img id="photo2" src="./photos/photo2.jpg" crossorigin="anonymous">
            <img id="photo3" src="./photos/photo3.jpg" crossorigin="anonymous">
            <img id="photo4" src="./photos/photo4.jpg" crossorigin="anonymous">
            <img id="photo5" src="./photos/photo5.jpg" crossorigin="anonymous">
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0">
            <!-- –í—ñ–¥–µ–æ -->
            <a-video src="#video1" width="1.7" height="3.0" position="0 0 0" visible="false" id="videoEntity1"></a-video>
            <a-video src="#video2" width="1.7" height="3.0" position="0 0 0" visible="false" id="videoEntity2"></a-video>
            
            <!-- –§–æ—Ç–æ -->
            <a-image src="#photo1" width="1.7" height="3.0" position="0 0 0" visible="false" id="photoEntity1"></a-image>
            <a-image src="#photo2" width="1.7" height="3.0" position="0 0 0" visible="false" id="photoEntity2"></a-image>
            <a-image src="#photo3" width="1.7" height="3.0" position="0 0 0" visible="false" id="photoEntity3"></a-image>
            <a-image src="#photo4" width="1.7" height="3.0" position="0 0 0" visible="false" id="photoEntity4"></a-image>
            <a-image src="#photo5" width="1.7" height="3.0" position="0 0 0" visible="false" id="photoEntity5"></a-image>
        </a-entity>
    </a-scene>

    <!-- UI Elements -->
    <div class="feedback" id="feedback"></div>
    <div class="media-info" id="mediaInfo"></div>
    <div class="nav-dots" id="navDots"></div>
    <div class="media-controls" id="mediaControls">
        <button class="media-btn" id="prevBtn">‚óÄ –ü–æ–ø–µ—Ä–µ–¥–Ω—î</button>
        <button class="media-btn" id="playPauseBtn">‚ñ∂ –í—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏</button>
        <button class="media-btn" id="nextBtn">–ù–∞—Å—Ç—É–ø–Ω–µ ‚ñ∂</button>
        <button class="media-btn sound-btn" id="soundBtn">üîá –£–≤—ñ–º–∫. –∑–≤—É–∫</button>
        <button class="media-btn" id="saveBtn">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
        <button class="media-btn" id="shareBtn">üì§ –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—å</button>
    </div>
    <div id="markerHint">–ù–∞–ø—Ä–∞–≤—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —Ñ–æ—Ç–æ ü™Ω</div>

    <script>
        class ARGallery {
            constructor() {
                this.MEDIA_CONFIG = {
                    videos: [
                        { id: 'video1', entityId: 'videoEntity1', type: 'video', name: '–í—ñ–¥–µ–æ 1' },
                        { id: 'video2', entityId: 'videoEntity2', type: 'video', name: '–í—ñ–¥–µ–æ 2' }
                    ],
                    photos: [
                        { id: 'photo1', entityId: 'photoEntity1', type: 'photo', name: '–§–æ—Ç–æ 1' },
                        { id: 'photo2', entityId: 'photoEntity2', type: 'photo', name: '–§–æ—Ç–æ 2' },
                        { id: 'photo3', entityId: 'photoEntity3', type: 'photo', name: '–§–æ—Ç–æ 3' },
                        { id: 'photo4', entityId: 'photoEntity4', type: 'photo', name: '–§–æ—Ç–æ 4' },
                        { id: 'photo5', entityId: 'photoEntity5', type: 'photo', name: '–§–æ—Ç–æ 5' }
                    ]
                };

                this.allMedia = [...this.MEDIA_CONFIG.videos, ...this.MEDIA_CONFIG.photos];
                this.currentMediaIndex = 0;
                this.currentMediaType = 'video';
                
                this.initializeElements();
                this.setupState();
                this.bindEvents();
                this.adjustControlsForSafeArea();
                this.createNavigationDots();
                this.setupMediaSizes().catch(e => console.warn('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–µ–¥—ñ–∞:', e));
            }

            // === –ù–û–í–Ü –ú–ï–¢–û–î–ò –î–õ–Ø –ê–î–ê–ü–¢–ò–í–ù–ò–• –†–û–ó–ú–Ü–†–Ü–í ===
            calculateARSize(imgOrVideo, maxWidth = 1.7) {
                const naturalWidth = imgOrVideo.naturalWidth || imgOrVideo.videoWidth || 1;
                const naturalHeight = imgOrVideo.naturalHeight || imgOrVideo.videoHeight || 1;
                
                if (naturalWidth === 0 || naturalHeight === 0) {
                    return { width: maxWidth, height: maxWidth * 1.77 }; // fallback (16:9)
                }

                const aspectRatio = naturalHeight / naturalWidth;
                const width = maxWidth;
                const height = maxWidth * aspectRatio;

                return { width, height };
            }

            async setupMediaSizes() {
                // –û–±—Ä–æ–±–∫–∞ —Ñ–æ—Ç–æ
                for (const photo of this.MEDIA_CONFIG.photos) {
                    const img = document.getElementById(photo.id);
                    if (img.complete && img.naturalWidth > 0) {
                        this.applySizeToEntity(photo.entityId, img);
                    } else {
                        await new Promise(resolve => {
                            img.onload = () => {
                                this.applySizeToEntity(photo.entityId, img);
                                resolve();
                            };
                            img.onerror = resolve;
                        });
                    }
                }

                // –û–±—Ä–æ–±–∫–∞ –≤—ñ–¥–µ–æ
                for (const video of this.MEDIA_CONFIG.videos) {
                    const vid = document.getElementById(video.id);
                    if (vid.readyState >= 2) {
                        this.applySizeToEntity(video.entityId, vid);
                    } else {
                        await new Promise(resolve => {
                            vid.onloadeddata = () => {
                                this.applySizeToEntity(video.entityId, vid);
                                resolve();
                            };
                            vid.onerror = resolve;
                        });
                    }
                }
            }

            applySizeToEntity(entityId, mediaElement) {
                const { width, height } = this.calculateARSize(mediaElement, 1.7);
                const entity = document.getElementById(entityId);
                if (entity) {
                    entity.setAttribute('width', width);
                    entity.setAttribute('height', height);
                    console.log(`–†–æ–∑–º—ñ—Ä ${entityId}: ${width.toFixed(2)} x ${height.toFixed(2)}`);
                }
            }

            // === –†–ï–®–¢–ê –ö–û–î–£ (–ù–ï –ó–ú–Ü–ù–ï–ù–û, –ê–õ–ï –ó–ë–ï–†–ï–ñ–ï–ù–û) ===
            initializeElements() {
                this.scene = document.getElementById('arScene');
                this.loadingScreen = document.getElementById('loadingScreen');
                this.errorScreen = document.getElementById('errorScreen');
                this.errorMessage = document.getElementById('errorMessage');
                this.retryBtn = document.getElementById('retryBtn');
                this.feedbackEl = document.getElementById('feedback');
                this.markerHint = document.getElementById('markerHint');
                this.mediaControls = document.getElementById('mediaControls');
                this.navDots = document.getElementById('navDots');
                this.mediaInfo = document.getElementById('mediaInfo');
                
                this.prevBtn = document.getElementById('prevBtn');
                this.nextBtn = document.getElementById('nextBtn');
                this.playPauseBtn = document.getElementById('playPauseBtn');
                this.soundBtn = document.getElementById('soundBtn');
                this.saveBtn = document.getElementById('saveBtn');
                this.shareBtn = document.getElementById('shareBtn');

                this.videoElements = {
                    video1: document.getElementById('video1'),
                    video2: document.getElementById('video2')
                };
            }

            setupState() {
                this.state = {
                    isMarkerFound: false,
                    soundEnabled: false,
                    isPlaying: false
                };
                this.hasEverShownMedia = false;
                this.hideControlsTimeout = null;
            }

            createNavigationDots() {
                this.navDots.innerHTML = '';
                this.allMedia.forEach((media, index) => {
                    const dot = document.createElement('div');
                    dot.className = 'dot';
                    dot.dataset.index = index;
                    dot.addEventListener('click', () => this.switchToMedia(index));
                    this.navDots.appendChild(dot);
                });
                this.updateNavigationDots();
            }

            updateNavigationDots() {
                const dots = this.navDots.querySelectorAll('.dot');
                dots.forEach((dot, index) => {
                    dot.classList.toggle('active', index === this.currentMediaIndex);
                });
            }

            bindEvents() {
                window.addEventListener('error', (e) => this.handleGlobalError(e));

                if (window.visualViewport) {
                    window.visualViewport.addEventListener('resize', () => {
                        this.adjustControlsForSafeArea();
                    });
                }

                this.prevBtn.addEventListener('click', () => this.previousMedia());
                this.nextBtn.addEventListener('click', () => this.nextMedia());
                this.playPauseBtn.addEventListener('click', () => this.togglePlayPause());
                this.soundBtn.addEventListener('click', () => this.toggleSound());
                this.saveBtn.addEventListener('click', () => this.saveCurrentMedia());
                this.shareBtn.addEventListener('click', () => this.shareCurrentMedia());
                this.retryBtn.addEventListener('click', () => this.retryAR());

                Object.values(this.videoElements).forEach(video => {
                    video.addEventListener('loadeddata', () => console.log('Video loaded:', video.id));
                    video.addEventListener('error', (e) => this.handleVideoError(e));
                    video.addEventListener('ended', () => this.handleVideoEnd(video));
                });

                this.scene.addEventListener('renderstart', () => this.handleARLoad());
                this.scene.addEventListener('targetFound', () => this.handleTargetFound());
                this.scene.addEventListener('targetLost', () => this.handleTargetLost());
                this.scene.addEventListener('arError', (e) => this.handleARError(e));
            }

            adjustControlsForSafeArea() {
                if (window.visualViewport) {
                    const viewportHeight = window.visualViewport.height;
                    const layoutHeight = window.innerHeight;
                    const navBarHeight = Math.max(0, layoutHeight - viewportHeight);
                    this.mediaControls.style.bottom = `${30 + navBarHeight}px`;
                    this.navDots.style.bottom = `${100 + navBarHeight}px`;
                }
            }

            showMedia(index) {
                const media = this.allMedia[index];
                if (!media) return;

                this.allMedia.forEach(m => {
                    const entity = document.getElementById(m.entityId);
                    if (entity) entity.setAttribute('visible', false);
                });

                Object.values(this.videoElements).forEach(video => {
                    if (!video.paused) video.pause();
                });

                const currentEntity = document.getElementById(media.entityId);
                if (currentEntity) {
                    currentEntity.setAttribute('visible', true);
                    if (media.type === 'video') {
                        const videoEl = this.videoElements[media.id];
                        if (videoEl) {
                            this.currentMediaType = 'video';
                            this.state.isPlaying = true;
                            videoEl.currentTime = 0;
                            videoEl.play().catch(e => console.warn('Play failed'));
                            this.playPauseBtn.innerHTML = '‚è∏ –ü–∞—É–∑–∞';
                            this.playPauseBtn.classList.remove('disabled');
                        }
                    } else {
                        this.currentMediaType = 'photo';
                        this.state.isPlaying = false;
                        this.playPauseBtn.innerHTML = '‚ñ∂ –í—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏';
                        this.playPauseBtn.classList.add('disabled');
                    }
                }

                this.currentMediaIndex = index;
                this.updateNavigationDots();
                this.updateMediaControls();
                this.updateMediaInfo(media);
            }

            getCurrentMedia() {
                return this.allMedia[this.currentMediaIndex];
            }

            updateMediaControls() {
                const media = this.getCurrentMedia();
                this.saveBtn.innerHTML = media.type === 'video' ? 'üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –≤—ñ–¥–µ–æ' : 'üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ —Ñ–æ—Ç–æ';
                
                this.soundBtn.innerHTML = this.state.soundEnabled ? 'üîä –í–∏–º–∫. –∑–≤—É–∫' : 'üîá –£–≤—ñ–º–∫. –∑–≤—É–∫';
                this.soundBtn.classList.toggle('on', this.state.soundEnabled);
            }

            updateMediaInfo(media) {
                this.mediaInfo.textContent = `${media.type === 'video' ? '–í—ñ–¥–µ–æ' : '–§–æ—Ç–æ'} ${this.currentMediaIndex + 1}/${this.allMedia.length}`;
                this.mediaInfo.classList.add('visible');
                setTimeout(() => this.mediaInfo.classList.remove('visible'), 3000);
            }

            switchToMedia(index) {
                if (index >= 0 && index < this.allMedia.length) {
                    this.showMedia(index);
                }
            }

            nextMedia() {
                let nextIndex = (this.currentMediaIndex + 1) % this.allMedia.length;
                this.showMedia(nextIndex);
                this.showFeedback('–ù–∞—Å—Ç—É–ø–Ω–µ ‚û°Ô∏è', true);
            }

            previousMedia() {
                let prevIndex = this.currentMediaIndex - 1;
                if (prevIndex < 0) prevIndex = this.allMedia.length - 1;
                this.showMedia(prevIndex);
                this.showFeedback('–ü–æ–ø–µ—Ä–µ–¥–Ω—î ‚¨ÖÔ∏è', true);
            }

            togglePlayPause() {
                const media = this.getCurrentMedia();
                if (media.type !== 'video') return;
                const videoEl = this.videoElements[media.id];
                if (!videoEl) return;

                if (this.state.isPlaying) {
                    videoEl.pause();
                    this.playPauseBtn.innerHTML = '‚ñ∂ –í—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏';
                    this.showFeedback('–ü–∞—É–∑–∞ ‚è∏', false);
                } else {
                    videoEl.play();
                    this.playPauseBtn.innerHTML = '‚è∏ –ü–∞—É–∑–∞';
                    this.showFeedback('–í—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è ‚ñ∂Ô∏è', true);
                }
                this.state.isPlaying = !this.state.isPlaying;
            }

            async toggleSound() {
                this.state.soundEnabled = !this.state.soundEnabled;
                Object.values(this.videoElements).forEach(video => {
                    video.muted = !this.state.soundEnabled;
                });

                if (this.state.soundEnabled) {
                    this.showFeedback('–ó–≤—É–∫ —É–≤—ñ–º–∫–Ω–µ–Ω–æ üîä', true);
                    const media = this.getCurrentMedia();
                    if (media.type === 'video') {
                        const videoEl = this.videoElements[media.id];
                        if (videoEl) {
                            try { await videoEl.play(); } catch (e) {}
                        }
                    }
                } else {
                    this.showFeedback('–ó–≤—É–∫ –≤–∏–º–∫–Ω–µ–Ω–æ üîá', false);
                }
                this.updateMediaControls();
            }

            async saveCurrentMedia() {
                try {
                    const media = this.getCurrentMedia();
                    const link = document.createElement('a');
                    link.href = `./${media.type === 'video' ? 'videos' : 'photos'}/${media.id}.${media.type === 'video' ? 'mp4' : 'jpg'}`;
                    link.download = `${media.name}.${media.type === 'video' ? 'mp4' : 'jpg'}`;
                    link.click();
                    this.showFeedback(`${media.type === 'video' ? '–í—ñ–¥–µ–æ' : '–§–æ—Ç–æ'} –∑–±–µ—Ä–µ–∂–µ–Ω–æ! üíæ`, true);
                } catch (error) {
                    this.showFeedback('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è üòî', false);
                }
            }

            async shareCurrentMedia() {
                try {
                    if (navigator.share) {
                        const media = this.getCurrentMedia();
                        await navigator.share({
                            title: media.name,
                            text: `–ü–æ–¥–∏–≤–∏—Å—å –Ω–∞ —Ü–µ ${media.type === 'video' ? '–≤—ñ–¥–µ–æ' : '—Ñ–æ—Ç–æ'}!`,
                            url: window.location.href,
                        });
                        this.showFeedback('–ü–æ–¥—ñ–ª–∏–ª–∏—Å—å —É—Å–ø—ñ—à–Ω–æ! üì§', true);
                    } else {
                        navigator.clipboard.writeText(window.location.href);
                        this.showFeedback('–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ! üìã', true);
                    }
                } catch (error) {
                    this.showFeedback('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–æ–¥—ñ–ª–∏—Ç–∏—Å—å üòî', false);
                }
            }

            handleVideoEnd(video) {
                setTimeout(() => this.nextMedia(), 500);
            }

            showFeedback(text, isGood = true) {
                this.feedbackEl.textContent = text;
                this.feedbackEl.style.color = isGood ? '#d4af37' : '#ff6b6b';
                this.feedbackEl.classList.add('visible');
                setTimeout(() => this.feedbackEl.classList.remove('visible'), 1500);
            }

            showMediaControls(show) {
                if (show) {
                    this.mediaControls.classList.add('visible');
                    this.navDots.classList.add('visible');
                } else {
                    this.mediaControls.classList.remove('visible');
                    this.navDots.classList.remove('visible');
                }
            }

            hideMarkerHint() { 
                this.markerHint.classList.add('hidden'); 
            }
            
            showMarkerHint() { 
                this.markerHint.classList.remove('hidden'); 
            }

            hideLoading() { 
                this.loadingScreen.style.display = 'none'; 
            }

            showError(msg) { 
                this.errorMessage.textContent = msg; 
                this.errorScreen.classList.add('visible'); 
                this.hideLoading(); 
            }

            hideError() { 
                this.errorScreen.classList.remove('visible'); 
            }

            handleARLoad() {
                this.hideLoading();
                this.scene.classList.add('ready');
            }

            handleTargetFound() {
                this.state.isMarkerFound = true;
                if (this.hideControlsTimeout) {
                    clearTimeout(this.hideControlsTimeout);
                    this.hideControlsTimeout = null;
                }
                this.hideMarkerHint();
                this.showMediaControls(true);
                if (!this.hasEverShownMedia) {
                    this.showMedia(0);
                    this.hasEverShownMedia = true;
                }
            }

            handleTargetLost() {
                this.allMedia.forEach(m => {
                    const entity = document.getElementById(m.entityId);
                    if (entity) entity.setAttribute('visible', false);
                });
                Object.values(this.videoElements).forEach(video => {
                    if (!video.paused) video.pause();
                });
                this.state.isPlaying = false;

                if (this.hideControlsTimeout) clearTimeout(this.hideControlsTimeout);
                this.hideControlsTimeout = setTimeout(() => {
                    if (!this.state.isMarkerFound) {
                        this.showMediaControls(false);
                        this.showMarkerHint();
                    }
                }, 1500);
            }

            handleGlobalError(e) { this.showError('–ù–µ–æ—á—ñ–∫—É–≤–∞–Ω–∞ –ø–æ–º–∏–ª–∫–∞'); }
            handleVideoError(e) { this.showFeedback('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–µ–æ', false); }
            handleARError(e) { this.showError('–ü–æ–º–∏–ª–∫–∞ AR: ' + (e.detail || '')); }

            retryAR() {
                this.hideError();
                this.loadingScreen.style.display = 'flex';
                setTimeout(() => window.location.reload(), 500);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => new ARGallery());
        } else {
            new ARGallery();
        }
    </script>
</body>
</html>
